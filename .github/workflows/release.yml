name: Release

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3)"
        required: true
        type: string

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25.3"

      - name: Get current version
        id: current_version
        run: |
          # Get the latest tag or start from v1.0.10
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.10")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Current latest tag: $LATEST_TAG"

      - name: Determine new version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual release - use provided version
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag push - use tag version
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            # Main branch push - auto-increment patch version
            CURRENT_VERSION=${{ steps.current_version.outputs.LATEST_TAG }}
            # Remove 'v' prefix and split version components
            VERSION_NUM=${CURRENT_VERSION#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Using version: ${{ steps.version.outputs.VERSION }}"

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from git commits since last tag
          LAST_TAG=${{ steps.current_version.outputs.LATEST_TAG }}
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${LAST_TAG}..HEAD 2>/dev/null || git log --pretty=format:"- %s (%h)" -n 10)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No significant changes detected"
          fi

          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and push tag (for main branch releases)
        if: github.ref == 'refs/heads/main'
        run: |
          NEW_VERSION="${{ steps.version.outputs.VERSION }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"

      - name: Build all binaries
        run: |
          # Build main binary
          go build -ldflags="-X github.com/mitexleo/backtide/cmd.version=${{ steps.version.outputs.VERSION }}" -o backtide
          # Build cross-platform binaries
          GOOS=linux GOARCH=amd64 go build -ldflags="-X github.com/mitexleo/backtide/cmd.version=${{ steps.version.outputs.VERSION }}" -o backtide-linux-amd64
          GOOS=darwin GOARCH=amd64 go build -ldflags="-X github.com/mitexleo/backtide/cmd.version=${{ steps.version.outputs.VERSION }}" -o backtide-darwin-amd64
          GOOS=windows GOARCH=amd64 go build -ldflags="-X github.com/mitexleo/backtide/cmd.version=${{ steps.version.outputs.VERSION }}" -o backtide-windows-amd64.exe

      - name: Test binary
        run: |
          ./backtide version
          ./backtide --help

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Backtide v${{ steps.version.outputs.VERSION }}
          body: |
            # Backtide v${{ steps.version.outputs.VERSION }}

            Automated release of Backtide backup utility

            ## Changes since last release:
            ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          files: |
            backtide
            backtide-linux-amd64
            backtide-darwin-amd64
            backtide-windows-amd64.exe
